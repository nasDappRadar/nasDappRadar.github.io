<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
        <title>星云应用雷达</title>
        <meta content="Admin Dashboard" name="description" />
        <meta content="Mannatthemes" name="author" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <link rel="shortcut icon" href="assets/images/favicon.ico">
        <link href="assets/plugins/morris/morris.css" rel="stylesheet">

        <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="assets/css/icons.css" rel="stylesheet" type="text/css">
        <link href="assets/css/style.css" rel="stylesheet" type="text/css">

        <!-- <link href="assets/css/bootstrap.css" rel='stylesheet' type='text/css' /> -->
        <link href="assets/css/style.1.css" rel='stylesheet' type='text/css' />
        <link href="assets/css/animate.css" rel="stylesheet" type="text/css" media="all">

    </head>


    <body onload="loadDapps();">

        <!-- Loader -->
        <div id="preloader"><div id="status"><div class="spinner"></div></div></div>

        <!-- Navigation Bar-->
        <header id="topnav">
            <div class="topbar-main">
                <div class="container-fluid">
                    <div class="logo">
                        <!-- Text Logo -->
                        <!-- <a href="index.html" class="logo" style="color:blue">
                        Annex
                        </a> -->
                        <!-- Image Logo -->
                        <a href="index.html" class="logo">
                            <!-- <img src="assets/images/radar.png" alt="" height="22" class="logo-small"> -->
                            <img src="assets/images/radar.png" alt="" height="20" class="logo-large">
                            星云应用雷达
                        </a>

                    </div>
                    
                    <!--
                    <div class="col-md-4 offset-md-2 searchInput">
                            <div class="input-group mt-2" id="loginButton">
                                <input type="text" class="form-control" placeholder="输入账户地址，只看我的添加和关注！" id="userAddress">
                                <span class="input-group-append">
                                    <button class="btn btn-primary" type="button" onclick="userLogin();">登录</button>
                                </span>
                            </div>
                    </div>
                    -->

                    <div class="clearfix"></div>

                </div> 
            </div>
            
            <div class="navbar-custom">
                <div class="container-fluid">
                    <div id="navigation">
                       
                        <ul class="navigation-menu">

                            <li class="has-submenu">
                                <a href="index.html"><i class="mdi mdi-bank"></i>主页</a>
                            </li>

                            <li class="has-submenu">
                                <a href="user.html" ><i class="mdi mdi-clipboard-account"></i>个人中心</a>
                            </li>

                            <li class="has-submenu">
                                    <a href="#" data-toggle="modal" data-target="#myModal4"><i class="mdi mdi-basket-fill"></i>添加应用</a>
                            </li>

                            <li class="has-submenu">
                                    <a href="help.html"><i class="mdi mdi-book-open-page-variant"></i>使用教程</a>
                            </li>

                            <li class="has-submenu">
                                    <a href="#" data-toggle="modal" data-target="#myModal2"><i class="mdi mdi-email"></i>联系我们</a>
                            </li>
                        </ul>
                    </div> 
                </div> 
            </div> 
        </header>
        <!-- End Navigation Bar-->

        <!-- wrapper -->
        <div class="wrapper">
            <div class="container-fluid">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="page-title-box">
                            <!-- <div class="btn-group pull-right">
                                <ol class="breadcrumb hide-phone p-0 m-0">
                                    <li class="breadcrumb-item"><a href="#">Annex</a></li>
                                    <li class="breadcrumb-item active">Dashboard</li>
                                </ol>
                            </div>
                            <h4 class="page-title">Dashboard</h4> -->
                        </div>
                    </div>
                </div>
               
                <div class="row">
                    <!-- Column -->
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="card m-b-30">
                            <div class="card-body">
                                <div class="d-flex flex-row">
                                    <div class="col-3 align-self-center">
                                        <div class="round">
                                            <i class="mdi mdi-basket"></i>
                                        </div>
                                    </div>
                                    <div class="col-6 align-self-center text-center">
                                        <div class="m-l-10">
                                            <h5 class="mt-0 round-inner" id="totalDapp">0</h5>
                                            <p class="mb-0 text-muted">应用总数</p>                                                                 
                                        </div>
                                    </div>
                                    <!--
                                    <div class="col-3 align-self-end align-self-center" id="dappPercent">
                                        <h6 class="m-0 float-right text-center text-success"> <i class="mdi mdi-arrow-up"></i> <span>0.00%</span></h6>
                                    </div>
                                -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="card m-b-30">
                            <div class="card-body">
                                <div class="d-flex flex-row">
                                    <div class="col-3 align-self-center">
                                        <div class="round">
                                            <i class="mdi mdi mdi-cash-usd"></i>
                                        </div>
                                    </div>
                                    <div class="col-6 text-center align-self-center">
                                        <div class="m-l-10 ">
                                            <h5 class="mt-0 round-inner"  id="totalBalance">0</h5>
                                            <p class="mb-0 text-muted">总金额</p>
                                        </div>
                                    </div>
                                    <!--
                                    <div class="col-3 align-self-end align-self-center" id="balancePercent">
                                        <h6 class="m-0 float-right text-center text-success"> <i class="mdi mdi-arrow-up"></i> <span>0.00%</span></h6>
                                    </div>  
                                -->                                                      
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="card m-b-30">
                            <div class="card-body">
                                <div class="d-flex flex-row">
                                    <div class="col-3 align-self-center">
                                        <div class="round ">
                                            <i class="mdi mdi-cart"></i>
                                        </div>
                                    </div>
                                    <div class="col-6 align-self-center text-center">
                                        <div class="m-l-10 ">
                                            <h5 class="mt-0 round-inner" id="totalVolume">0</h5>
                                            <p class="mb-0 text-muted">日交易量</p>
                                        </div>
                                    </div>
                                    <!--
                                    <div class="col-3 align-self-end align-self-center" id="tradePercent">
                                        <h6 class="m-0 float-right text-center text-success"> <i class="mdi mdi-arrow-up"></i> <span>0.00%</span></h6>
                                    </div>
                                    --> 
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                    <!-- Column -->
                    <div class="col-md-6 col-lg-6 col-xl-3">
                        <div class="card m-b-30">
                            <div class="card-body">
                                <div class="d-flex flex-row">
                                    <div class="col-3 align-self-center">
                                        <div class="round">
                                            <i class="mdi mdi-account-multiple-plus"></i>
                                        </div>
                                    </div>
                                    <div class="col-6 align-self-center text-center">
                                        <div class="m-l-10">
                                            <h5 class="mt-0 round-inner"  id="totalDau">0</h5>
                                            <p class="mb-0 text-muted">日活跃量</p>
                                        </div>
                                    </div>
                                    <!--
                                    <div class="col-3 align-self-end align-self-center" id="userPercent">
                                        <h6 class="m-0 float-right text-center text-success"> <i class="mdi mdi-arrow-up"></i> <span>0.00%</span></h6>
                                    </div>
                                    -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Column -->
                </div>      
                
                <div class="row">
                    <div class="col-md-12 col-lg-12 col-xl-12 align-self-center">
                        <div class="card bg-white m-b-30">
                            <div class="card-body new-user">
                                <h5 class="header-title mb-4 mt-0" id="dappListName">优秀应用列表</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <!--<th class="border-top-0" style="width:60px;"><img src="assets/images/radar.png" alt="" height="20" class="logo-large"></th>
                                                -->
                                                <th class="border-top-0">名称</th>
                                                <th class="border-top-0">应用类型</th>
                                                <th class="border-top-0">余额</th>
                                                <th class="border-top-0">日活</th>                                    
                                                <th class="border-top-0">日量</th>
                                                <th class="border-top-0">总量</th>
                                                <th class="border-top-0">关注</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dappList">
                                            
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>

            </div> 
        </div>
        <!-- end wrapper -->
        <!-- Footer -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                            © 2018 本网站由<a href="https://nebulas.io/cn/">星云链</a>提供区块链服务.
                    </div>
                </div>
            </div>
        </footer>
        <!-- End Footer -->
        <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>						
                        </div>
                            <section>
                                <div class="modal-body modal-spa">
                                    <div class="writ">
                                        <h4>欢迎通过以下邮箱与我联系：</h4>
                                        <h4>17780487248@163.com</h4>
                                    </div>
                                </div>
                            </section>
                    </div>
                </div>
        </div>
        
        <div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>						
                        </div>
                            <section>
                                <div class="modal-body modal-spa">
                                    <div class="writ", id="newWindow">
                                        <h4>请在浏览器插件中完成操作！</h4>
                                    </div>
                                </div>
                            </section>
                    </div>
                </div>
        </div>

        <div class="modal fade" id="myModal4" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>						
                        </div>
                            <section>
                                <div class="modal-body modal-spa">
                                    <div class="writ", id="newWindow1">
                                        <h4>添加应用</h4>
                                            <ul>
                                                <li class="na-me">
                                                    <input class="name" id="dappName" type="text" placeholder="请输入应用名称(必填)">
                                                </li>
                                                <li class="na-me">
                                                    <input class="balance" id="dappType" type="text" placeholder="请输入应用类型(必填)">
                                                </li>
                                                <li class="na-me">
                                                    <input class="address" id="dappAddress" type="text" placeholder="请输入合约地址(必填)">
                                                </li>
                                                <li class="na-me">
                                                        <input class="balance" id="dappUrl" type="text" placeholder="请输入官网URL(选填)">
                                                </li>
                                                <div class="clearfix"></div>
                                            </ul>
                                            <div class="sub-bn form-group" style="text-align: center">
                                                <!-- <div class="col-sm-6"> -->
                                                    <button type="button" class="btn btn-primary btn-block waves-effect waves-light" onclick="tianjia();">确定</button>
                                                <!-- </div> -->
                                                <!-- <div class="col-sm-6">
                                                <form>
                                                    <button class="subbtn">取消</button>
                                                </form>
                                                </div> -->
                                            </div>
                                    </div>
                                </div>
                            </section>
                    </div>
                </div>
        </div>


        <!-- jQuery  -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/popper.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
        <script src="assets/js/modernizr.min.js"></script>
        <script src="assets/js/waves.js"></script>
        <script src="assets/js/jquery.slimscroll.js"></script>
        <script src="assets/js/jquery.nicescroll.js"></script>
        <script src="assets/js/jquery.scrollTo.min.js"></script>
        <script src="assets/plugins/skycons/skycons.min.js"></script>
        <script src="assets/plugins/raphael/raphael-min.js"></script>
        <script src="assets/plugins/morris/morris.min.js"></script>
        <script src="assets/pages/dashborad.js"></script>

        <!-- App js -->
        <script src="assets/js/app.js"></script>
        <script src="lib/nebulas.js"></script>
        <script src="lib/nebPay.js"></script>
        <script>

            'use strict';
            var Neb = require("nebulas").Neb;
            var HttpRequest = require("nebulas").HttpRequest
            var NebPay = require("nebpay");
            var nebPay = new NebPay(); 
            var Account = require("nebulas").Account;
            var contractAddress = "n1rjDKkqyho4j39cUzZpQ9ay97jq4UYiaQ1";
            var intervalQuery;

            var neb = new Neb();
            var chainId = 1;
            var netWork = "https://mainnet.nebulas.io"
            //var chainId = 1001;
            //var netWork = "https://testnet.nebulas.io"
            neb.setRequest(new HttpRequest(netWork));

            var login = localStorage.getItem("login");
            var totalDapp = 0;
            var totalBalance = 0;
            var totalTrade = 0;
            var totalDau = new Set();
            var liList = new Array();
            var sortList = new Array();

            function getUrl(url) {
                return new Promise( function(resolve, reject){
                    var xhr = new XMLHttpRequest();
                    xhr.open('get',url,true);
                    xhr.responseType ='json';
                    xhr.onload =  function(){
                        var status = xhr.status;
                        if (status == 200) {
                            var resp = xhr.response;
                            //console.log(resp)
                            var page = resp.data.totalPage;
                            var txList = resp.data.txnList;
                            var txnCnt = resp.data.txnCnt;
                            //console.log(resp)
                            var stop = 0;
                            for(var i=0; i<txList.length; i++) {
                                var tx = txList[i];
                                var timeDiff = tx.currentTimestamp - tx.createdAt;
                                if (timeDiff > 604800000) {
                                    stop = 1;
                                    break;
                                }
                            }
                            var result = {
                                page: page,
                                txList: txList,
                                txnCnt: txnCnt,
                                stop: stop
                            }
                            resolve(result);
                        } else {
                            reject(status);
                        }
                    };
                    xhr.send();
                })
            }

            function getDapp(dapp){
                return new Promise( function(resolve, reject){
                    var taskList = new Array();
                    var address = dapp.address
                    var firstUrl= `https://explorer.nebulas.io/main/api/tx?a=${address}&p=1`;
                    getUrl(firstUrl).then(function(result){
                        var page = result.page;
                        var stop = result.stop;
                        var txList = result.txList;
                        var txnCnt = result.txnCnt;
                        console.log(txnCnt)
                        //console.log(result)
                        if (stop == 0) {
                            for (var i=2; i<= parseInt(page); i++) {
                                var url = `https://explorer.nebulas.io/main/api/tx?a=${address}&p=${i}`;
                                taskList.push(getUrl(url))
                            }
                            Promise.all(taskList).then(function(dataList) {
                                for (var j=0; j< dataList.length; j++) {
                                    var data = dataList[j];
                                    var newTxList = data.txList;
                                    txList = txList.concat(newTxList);
                                }
                                var result = {
                                    dapp: dapp,
                                    txList: txList,
                                    txnCnt: txnCnt
                                }
                                showLIst(result)
                                resolve(result)
                            })
                        } else {
                            var result = {
                                dapp: dapp,
                                txList: txList,
                                txnCnt: txnCnt
                            }
                            showLIst(result)
                            resolve(result)
                        }
                        
                    }).catch(function(err) {
                        console.log(err);
                        resolve(null);
                    });
                });
            };

            function showLIst(result) {
                var dapp = result.dapp;
                var txList = result.txList;
                var txnCnt = result.txnCnt;
                
                var dauSet = new Set();
                var dailyVolume = 0;
                var weeklyVolume = 0;
                var dailyBalance = 0;
                var weeklyBalance = 0;

                var balance = 0
                if (txList.length > 0){
                    console.log(txList)
                    balance = txList[0].to.balance;
                    totalDapp += 1;
                    totalBalance += parseInt(balance);

                    for (var j=0; j<txList.length; j+=1){
                        var tx = txList[j];
                        var timeDiff = tx.currentTimestamp - tx.createdAt;
                        if (timeDiff <= 86400000){
                            dauSet.add(tx.from.hash)
                            totalDau.add(tx.from.hash)
                            
                            dailyVolume += 1;
                            dailyBalance += parseInt(tx.value);
                            
                            totalTrade += 1;
                            
                            weeklyVolume += 1;
                            weeklyBalance += parseInt(tx.value);

                        } else if (timeDiff <= 604800000){
                            
                            weeklyVolume += 1;
                            weeklyBalance += parseInt(tx.value);
                        }
                    }
                    var demicals = 1e18;
                    var buttonColor
                    if (dapp.type == '游戏') {
                        buttonColor = "success"
                    } else if (dapp.type == '工具'){
                        buttonColor = "warning"
                    } else {
                        buttonColor = "danger"
                    }
                    
                    var guanzhu;
                    if (!login){
                        guanzhu = `<button type="button" class="btn btn-outline-primary waves-effect waves-light" onclick="guanzhu(${dapp.id});" data-toggle="modal" data-target="#myModal3">关注</button>`
                    } else {
                        guanzhu = `<button type="button" class="btn btn-outline-primary waves-effect waves-light" onclick="shanchu(${dapp.id});" data-toggle="modal" data-target="#myModal3">删除</button>`
                    }
                    
                    var newTr = `
                    <tr>
                        
                        <td>
                            <a href="./detail.html?name=${dapp.name}&address=${dapp.address}&url=${dapp.url}">${dapp.name}</a>
                        </td>
                        <td> <button type="button" class="btn btn-${buttonColor} waves-effect waves-light">${dapp.type}</button></td>
                        <td>${(balance/demicals).toFixed(2)}</td>
                        <td>${dauSet.size}</td> 
                        <td>${dailyVolume}</td>
                        <td id="txnCnt">${txnCnt}</td>                                   
                        <td>
                            ${guanzhu}
                        </td>
                    </tr>`

                    var liObj = {
                        html: newTr,
                        txnCnt: txnCnt
                    }
                    //<td>${weeklyVolume}</td>
                    //<td>${dailyVolume}/${weeklyVolume}</td>
                    //<td>${(dailyBalance/demicals).toFixed(2)}/${(dailyBalance/demicals).toFixed(2)}</td>
                    
                    
                    liList.push(liObj);
                    if (liList.length>1){
                        liList.sort(function(li1, li2){
                            var n1=parseInt(li1.txnCnt);  
                            var n2=parseInt(li2.txnCnt);  
                            return n2-n1;  //升序排列  
                        });
                        document.getElementById("dappList").innerHTML = ""
                        for(var i=0;i<liList.length;i++){  
                            document.getElementById("dappList").insertAdjacentHTML('beforeend', liList[i].html);   //排序之后再写入  
                        } 
                    } else {
                        document.getElementById("dappList").innerHTML = ""
                        document.getElementById("dappList").insertAdjacentHTML('beforeend', newTr)
                    }
                    
                    var demicals = 1e18;
                    var fixedBalance = (totalBalance/demicals).toFixed(2)
                    console.log(totalDapp)
                    console.log(fixedBalance)
                    document.getElementById("totalDapp").innerText = totalDapp
                    document.getElementById("totalBalance").innerText = fixedBalance
                    document.getElementById("totalVolume").innerText = totalTrade
                    document.getElementById("totalDau").innerText = totalDau.size 
                }
                    
            }

            function startHttpQuery(data){     
                var queryList = new Array();
                var nullCount = 0;
                for (var i=0; i<data.length; i++){
                    var dapp = data[i];
                    if (dapp){
                        queryList.push(getDapp(dapp));
                    } else{
                        nullCount += 1;
                    }
                }
                if (nullCount == data.length){
                    document.getElementById("dappList").innerHTML = ""
                    alert("您还没有自己的应用，快去添加或者关注吧！")
                } else{
                Promise.all(queryList).then(function(dataList){
                    
                    })
                     
                }
            };

            function loadDapps() {
                //localStorage.removeItem("login");
                //localStorage.removeItem("userAddress");
                document.getElementById("dappList").innerHTML = `<tr>
                        <td></td>
                        <td>
                            <a href="">正在从星云链加载数据，加载请稍等。。。</a>
                        </td>
                        
                    </tr>`;
                /*
                if (login){
                    var address = localStorage.getItem("userAddress")
                    document.getElementById("dappListName").innerText = "我的应用列表"
                    document.getElementById("loginButton").innerHTML = `
                        <input type="text" class="form-control" value="${address}" disabled="true">
                        <span class="input-group-append">
                            <button class="btn btn-primary" type="button" onclick="userLogout();">退出</button>
                        </span>`
                    neb.api.call({
                        chainID: chainId,
                        from: address,
                        to: contractAddress,
                        value: 0,
                        nonce: 0,
                        gasPrice: 1000000,
                        gasLimit: 2000000,
                        contract: {
                            function: "getPrivate",
                            args: JSON.stringify([]),
                        }
                    }).then(function (resp) {
                        console.log(resp)
                        var result = JSON.parse(resp.result)
                        console.log(result)
                        startHttpQuery(result)
                    }).catch(function(err) {
                        console.log(err);
                    })
                }else{
                    */
                    var dapps = JSON.parse(sessionStorage.getItem("publicDapps"))
                    if (dapps){
                        console.log("本地加载")
                        startHttpQuery(dapps)
                    } else {
                        neb.api.call({
                            chainID: chainId,
                            from: contractAddress,
                            to: contractAddress,
                            value: 0,
                            nonce: 0,
                            gasPrice: 1000000,
                            gasLimit: 2000000,
                            contract: {
                                function: "getPublic",
                                args: JSON.stringify([]),
                            }
                        }).then(function (resp) {
                            sessionStorage.setItem("publicDapps", resp.result)
                            var result = JSON.parse(resp.result)
                            startHttpQuery(result)
                        }).catch(function(err) {
                            console.log(err);
                        })
                    }
                //}
            }
            
            function userLogin(){
                document.getElementById("dappList").innerHTML = `<tr>
                        <td></td>
                        <td>
                            <a href="">正在从星云链加载数据，加载请稍等。。。</a>
                        </td>
                        
                    </tr>`;
                var address = document.getElementById("userAddress").value.trim();
                if (address === "") {
                    alert("请填写您的账户地址！");
                } else if (!Account.isValidAddress(address)) {
                    alert("您输入的地址无效，请检查是否输入错误！");
                } else {
                    neb.api.call({
                        chainID: chainId,
                        from: address,
                        to: contractAddress,
                        value: 0,
                        nonce: 0,
                        gasPrice: 1000000,
                        gasLimit: 2000000,
                        contract: {
                            function: "getPrivate",
                            args: JSON.stringify([]),
                        }
                    }).then(function (resp) {
                        console.log(resp)
                        if (resp.result == 0){
                            alert("您还没有自己的应用，快去添加或者关注吧！") 
                        } else {
                            login = true;
                            localStorage.setItem("login", true)
                            localStorage.setItem("userAddress", address)
                            var result = JSON.parse(resp.result)
                            console.log(result)
                            //document.getElementById("dappList").innerHTML = "";
                            document.getElementById("dappListName").innerText = "我的应用列表"
                            document.getElementById("loginButton").innerHTML = `
                                <input type="text" class="form-control" value="${address}" disabled="true">
                                <span class="input-group-append">
                                    <button class="btn btn-primary" type="button" onclick="userLogout();">退出</button>
                                </span>`
                            //startHttpQuery(result)
                            location.reload()
                        }
                    }).catch(function(err) {
                        console.log(err);
                    })
                }
            }
            
            function userLogout(){
                localStorage.removeItem("login");
                localStorage.removeItem("userAddress");
                location.reload();
            }
            
            function guanzhu(id){
                var to = contractAddress;
                var value = 0;
                var callFunction = "guanzhuPrivate";
                var callArgs =  JSON.stringify([id]);
                var options = {
                    listener: function (resp) {
                        intervalQuery = setInterval(function() {
                            funcIntervalQuery(resp.txhash);
                        }, 5000);
                    }
                }
                //发送交易(发起智能合约调用)
                nebPay.call(to, value, callFunction, callArgs, options);
            }

            function shanchu(id){
                var to = contractAddress;
                var value = 0;
                var callFunction = "delPrivate";
                var callArgs =  JSON.stringify([id]);
                var options = {
                    listener: function (resp) {
                        intervalQuery = setInterval(function() {
                            funcIntervalQuery(resp.txhash);
                        }, 5000);
                    }
                }
                //发送交易(发起智能合约调用)
                nebPay.call(to, value, callFunction, callArgs, options);
            }

            function tianjia(){
                var name = document.getElementById("dappName").value.trim();
                var type = document.getElementById("dappType").value.trim();
                var address = document.getElementById("dappAddress").value.trim();
                var url = document.getElementById("dappUrl").value.trim();
                
                if (!Account.isValidAddress(address)){
                    alert("您输入的地址不正确，请重新确认合约地址！")
                }else if(!name || !type || !address ){
                    alert("请填写必要的参数！")
                } else {
                    var dapp = {
                        name: name,
                        type: type,
                        address: address,
                        url: url
                    }
                    var to = contractAddress;
                    var value = 0;
                    var callFunction = "savePrivate";
                    var callArgs =  JSON.stringify([dapp]);
                    var options = {
                        listener: function (resp) {
                            intervalQuery = setInterval(function() {
                                funcIntervalQuery(resp.txhash);
                            }, 5000);
                        }
                    }
                    //发送交易(发起智能合约调用)
                    nebPay.call(to, value, callFunction, callArgs, options);
                }

            }

            function funcIntervalQuery(txhash) {
                newWindow.innerHTML = `<h4>正在查询结果，请稍等...</h4>`
                newWindow1.innerHTML = `<h4>正在查询结果，请稍等...</h4>`
                receiptTransaction(txhash).then(function(resp){
                    var respObject = resp;
                    console.log(respObject)
                    if (respObject.status == 1){
                        clearInterval(intervalQuery);
                        newWindow.innerHTML = `<h4>执行成功!</h4>`
                        newWindow1.innerHTML = `<h4>应用添加成功!</h4>`
                        //location.reload();
                        var address = resp.from;
                        console.log(address)
                        login = true;
                        //localStorage.setItem("login", true)
                        localStorage.setItem("userAddress", address)
                        setTimeout(window.location.href="user.html", 3000)
                    } else if (respObject.status == 0) {
                        newWindow.innerHTML = `
                        <h4>啊哦，好像哪里出错了！</h4>
                        <h4>您可以根据以下哈希，再次确认您的交易状态:</h4>
                        <div class="hash">
                            <p>${txhash}</p>
                        </div>`
                    }
                }).catch(function(err){
                    newWindow.innerHTML = `
                    <h4>啊哦，好像哪里出错了！</h4>
                    <h4>您可以根据以下哈希，再次确认您的交易状态:</h4>
                        <div class="hash">
                            <p>${txhash}</p>
                        </div>`
                })
            }
            
            var receiptTransaction = function(txhash) {
                var promise = new Promise(function(resolve, reject){
                    neb.api.getTransactionReceipt(txhash).then(function (resp) {
                        resolve(resp);
                    }).catch(function(err) {
                        console.log(err);
                    });
                });
                return promise
            }

        </script>



    </body>
</html>